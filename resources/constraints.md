# LLMの制約と対策

## 🧠 主要な制約

### 1. コンテキストウィンドウの制限
**制約の内容**
- 一度に処理できるトークン数に上限
- モデルにより異なる（4k〜200k tokens）
- 長すぎると最初か最後しか覚えない

**実践的な対策**
```
対策1：重要情報の配置
┌─────────────────┐
│  重要な設定     │ ← 冒頭20%
├─────────────────┤
│  詳細な描写     │ ← 中間60%
├─────────────────┤
│  重要な結論     │ ← 末尾20%
└─────────────────┘
```

```
対策2：チャンク分割
長編小説（40,000字）
　↓
10章に分割（各4,000字）
　↓
章ごとに処理
　↓
要約で繋ぐ
```

### 2. Lost in the Middle現象
**制約の内容**
- 長文の中央部分の情報を忘れやすい
- 特に8,000トークンを超えると顕著
- 重要な情報が抜け落ちる

**具体的な対策**

#### パターン1：重要情報のリピート
```markdown
# 第1章
主人公・田中美咲は「知識の共有」を信条とする司書。

# 第3章
美咲は、いつもの「知識の共有」という信念に従い...

# 第5章
「知識の共有」を大切にする美咲にとって...
```

#### パターン2：構造化による対策
```
シーンテンプレート：
┌─────────────────────┐
│ 【要約】前回まで    │
│ 【設定】現在の状況  │
│ 【本文】シーン内容  │
│ 【次回】次への布石  │
└─────────────────────┘
```

### 3. 時系列の混乱
**制約の内容**
- 複数の時間軸を管理できない
- フラッシュバックで混乱
- 日付の整合性が取れない

**時系列管理の手法**

```
タイムライン明示法：
━━━━━━━━━━━━━━━━━━━━━━
2024年3月15日 午前9時 - 事件発生
　　　　↓（2時間後）
2024年3月15日 午前11時 - 警察到着
　　　　↓（回想シーン）
[回想] 2024年3月10日 - 予兆
　　　　↓（現在に戻る）
2024年3月15日 午後2時 - 捜査開始
━━━━━━━━━━━━━━━━━━━━━━
```

### 4. 物理的空間の把握
**制約の内容**
- 3次元空間の位置関係を維持できない
- 建物の構造を忘れる
- 移動の論理性が破綻

**シンプルな空間設計**
```
推奨：単純な配置
[1F: 書店] → [道路] → [2F: カフェ]

非推奨：複雑な配置
[1F: 書店] → [中庭] → [別棟2F] → [渡り廊下] → [本館3F]
```

### 5. キャラクターの一貫性
**制約の内容**
- 性格が場面により変わる
- 設定を忘れる
- 口調が統一されない

**キャラクターカードシステム**
```yaml
キャラクター: 佐藤明日香
━━━━━━━━━━━━━━━━━
必須要素（全シーンで維持）:
  - 価値観: "知識の共有"
  - 口癖: "もしよろしければ"
  - 仕草: 眼鏡を押し上げる

可変要素（状況により変化）:
  - 感情表現
  - 行動の積極性
  - 話す量
━━━━━━━━━━━━━━━━━
```

## 🛠️ 実装テクニック

### テクニック1：プロンプトチェーン
```
Step 1: キャラクター設定生成
　　↓ 出力を保存
Step 2: [設定] + プロット生成
　　↓ 出力を保存
Step 3: [設定] + [プロット] + シーン生成
```

### テクニック2：要約ブリッジ
```
章の終わり：
「この章の要約（100字）：
美咲は老婦人と出会い、母の手紙を発見。
過去との繋がりが明らかになり始めた。」

次章の始まり：
「前章の要約：[上記を挿入]
さて、手紙を読み始めた美咲は...」
```

### テクニック3：制約の明示
```
以下の制約を守ってください：
1. 場所は3箇所まで
2. 時系列は順行のみ
3. 登場人物は5人まで
4. 視点は主人公固定
```

## 📊 制約レベル別対応表

| 制約の種類 | 影響度 | 対策優先度 | 推奨対策 |
|-----------|--------|------------|----------|
| コンテキスト制限 | 高 | 必須 | チャンク分割 |
| Lost in the Middle | 高 | 必須 | 情報配置最適化 |
| 時系列混乱 | 中 | 重要 | タイムスタンプ |
| 空間把握 | 中 | 推奨 | シンプル化 |
| キャラクター性 | 高 | 必須 | カードシステム |

## 🔄 制約を活かす逆転の発想

### 制約が生む創造性

#### 1. コンテキスト制限 → 簡潔な文体
```
制限があるからこそ：
- 無駄を削ぎ落とした文章
- 本質的な描写に集中
- 読者の想像力を活用
```

#### 2. Lost in the Middle → 重要シーン中心主義
```
中央を忘れるなら：
- 冒頭と結末で勝負
- 印象的なシーンを両端に
- 中盤は雰囲気作りに徹する
```

#### 3. 時系列の単純化 → 分かりやすい構成
```
複雑にできないなら：
- 時系列順の素直な展開
- 回想は最小限に
- 現在進行形の緊張感
```

## 🎮 制約対応シミュレーション

### ケース1：10,000字の短編
```
構成案：
1. 冒頭（1,000字）- 設定と掴み
2. 前半（3,000字）- 展開
3. 中盤（2,000字）- 深化
4. 後半（3,000字）- クライマックス
5. 結末（1,000字）- 余韻

ポイント：
- 5つのブロックで管理
- 各ブロックで要約作成
- 重要情報は1, 5に配置
```

### ケース2：複数視点の物語
```
非推奨：
A視点→B視点→A視点→C視点→B視点

推奨：
第1部：A視点（完結）
第2部：B視点（完結）
第3部：C視点（完結）
終章：統合

ポイント：
- 視点ごとにまとめる
- 混在を避ける
- 各部で小さな完結
```

## 💡 トラブルシューティング

### Q：長編でキャラクターがぶれる
A：各章の冒頭に「キャラクターリマインダー」を挿入

### Q：複雑なプロットが破綻する
A：メインプロット1本に絞り、サブプロットは最小限に

### Q：場所の描写が矛盾する
A：場所を限定し、移動シーンを明示的に書く

## 🚀 将来の展望

### モデルの進化と制約の変化
- コンテキスト長は拡大傾向
- しかし、本質的な制約は残る
- 制約対応スキルは普遍的

### 新しいアプローチ
1. **RAG（検索拡張生成）**：外部記憶の活用
2. **ファインチューニング**：特定用途への最適化
3. **マルチエージェント**：役割分担での対応

---

🎯 **制約は創造性の母** - 制限があるからこそ、工夫が生まれ、独創的な解決策が見つかります。